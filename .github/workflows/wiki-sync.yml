name: Auto Wiki Sync

on:
  push:
    branches: [main, latest]
    paths:
      - 'docs/development/**'
  workflow_dispatch:

jobs:
  sync-to-wiki:
    runs-on: ubuntu-latest
    if: github.repository == 'Shiori-Takanashi/next-tpl'

    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check if Wiki exists
        id: wiki-check
        run: |
          WIKI_URL="https://github.com/${{ github.repository }}.wiki.git"
          echo "Checking Wiki repository: $WIKI_URL"
          if git ls-remote "$WIKI_URL" &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Wiki repository exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âŒ Wiki repository not found"
          fi

      - name: Clone or initialize Wiki
        run: |
          WIKI_URL="https://github.com/${{ github.repository }}.wiki.git"
          
          echo "ðŸ”„ Starting Wiki sync process..."
          echo "Repository: ${{ github.repository }}"
          echo "Wiki URL: $WIKI_URL"
          
          if [[ "${{ steps.wiki-check.outputs.exists }}" == "true" ]]; then
            echo "ðŸ“– Cloning existing Wiki..."
            git clone "$WIKI_URL" wiki-repo
            cd wiki-repo
            echo "ðŸ“‹ Current Wiki contents:"
            ls -la *.md 2>/dev/null || echo "No markdown files found"
            cd ..
          else
            echo "ðŸ†• Initializing new Wiki..."
            mkdir wiki-repo
            cd wiki-repo
            git init
            git remote add origin "$WIKI_URL"
            
            # Create initial Home page
            cat > Home.md << 'EOF'
          # Next.js Learning Template - Development Wiki

          ã“ã®Wikiã«ã¯ã€Next.jså­¦ç¿’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®è©³ç´°ãªé–‹ç™ºè¨˜éŒ²ã¨æŠ€è¡“ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

          ## ðŸ“‹ æœ€æ–°ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

          ã“ã®Wikiã¯ `docs/development/` ã‹ã‚‰è‡ªå‹•åŒæœŸã•ã‚Œã¦ã„ã¾ã™ã€‚

          ### ä¸»è¦ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
          - [[Project Overview|01-project-overview]] - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ¦‚è¦ã¨ç›®çš„
          - [[CI Workflow Modularization|24-ci-workflow-modularization]] - GitHub Actions CIãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–
          - [[Development Standards|25-development-standards]] - é–‹ç™ºç’°å¢ƒæ¨™æº–åŒ–

          ## ðŸ”— é–¢é€£ãƒªãƒ³ã‚¯

          - [ãƒ¡ã‚¤ãƒ³ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/${{ github.repository }})
          - [Issueå ±å‘Š](https://github.com/${{ github.repository }}/issues)
          - [Pull Request](https://github.com/${{ github.repository }}/pulls)

          ---
          *æœ€çµ‚æ›´æ–°: {{ date }}*
          *è‡ªå‹•åŒæœŸ: GitHub Actions*
          EOF

            git add Home.md
            git commit -m "wiki: Initialize Wiki with auto-sync"
            cd ..
          fi

      - name: Sync documentation files
        run: |
          cd wiki-repo
          
          echo "ðŸ“ Starting documentation sync..."
          echo "ðŸ“Š Source files count: $(find ../docs/development -name "*.md" | wc -l)"
          
          # Remove existing docs (except special Wiki files)
          find . -name "*.md" -not -name "Home.md" -not -name "_*.md" -delete
          
          echo "ðŸ“ Syncing documentation files..."
          
          # Copy all markdown files from docs/development
          find ../docs/development -name "*.md" | while read -r source_file; do
            basename_file=$(basename "$source_file")
            echo "Syncing: $basename_file"
            
            # Copy file with metadata
            {
              echo "<!-- Auto-synced from docs/development/$basename_file -->"
              echo "<!-- Last sync: $(date -u '+%Y-%m-%d %H:%M:%S UTC') -->"
              echo "<!-- Commit: ${{ github.sha }} -->"
              echo ""
              cat "$source_file"
            } > "$basename_file"
          done
          
          echo "âœ… Sync completed"
          echo "ðŸ“‹ Wiki files after sync:"
          ls -la *.md      - name: Update Wiki sidebar
        run: |
          cd wiki-repo

          cat > _Sidebar.md << 'EOF'
          ## ðŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

          ### åŸºç›¤ãƒ»è¨­è¨ˆ
          * [[Project Overview|01-project-overview]]
          * [[Docker Environment|02-docker-environment]]
          * [[Automation Tools|03-automation-tools]]
          * [[Documentation Strategy|04-documentation-strategy]]

          ### ãƒ†ã‚¹ãƒˆãƒ»å“è³ª
          * [[Testing Strategy|08-testing-strategy]]
          * [[Security Practices|09-security-practices]]
          * [[Performance Optimization|10-performance-optimization]]

          ### æŠ€è¡“å®Ÿè£…
          * [[TailwindCSS v4|13-tailwindcss-v4]]
          * [[VS Code Integration|14-vscode-integration]]
          * [[Next.js 16 + React 19|16-nextjs-16-react-19]]

          ### æœ€æ–°ã®æ”¹å–„
          * [[CI Workflow Modularization|24-ci-workflow-modularization]]
          * [[Development Standards|25-development-standards]]

          ### é‹ç”¨ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤
          * [[Production Deployment|20-production-deployment]]
          * [[Tools Extension|23-tools-extension]]

          ---
          [[ðŸ“‹ å®Œå…¨ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹|README]]

          *è‡ªå‹•åŒæœŸ: GitHub Actions*
          EOF

      - name: Update Wiki footer
        run: |
          cd wiki-repo

          cat > _Footer.md << 'EOF'
          ---
          ðŸ“– [å…¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](README) | ðŸ  [ãƒ¡ã‚¤ãƒ³ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/${{ github.repository }}) | ðŸ› [Issueå ±å‘Š](https://github.com/${{ github.repository }}/issues) | ðŸ”„ æœ€çµ‚åŒæœŸ: {{ date }}
          EOF

          # Replace date placeholder
          sed -i "s/{{ date }}/$(date -u '+%Y-%m-%d %H:%M:%S UTC')/g" _Footer.md

      - name: Update Home page timestamp
        run: |
          cd wiki-repo

          if [[ -f "Home.md" ]]; then
            sed -i "s/\*æœ€çµ‚æ›´æ–°:.*\*/\*æœ€çµ‚æ›´æ–°: $(date -u '+%Y-%m-%d %H:%M:%S UTC')\*/" Home.md
          fi

      - name: Commit and push to Wiki
        run: |
          cd wiki-repo

          # Check if there are any changes
          if git diff --quiet && git diff --cached --quiet; then
            echo "ðŸ“ No changes to sync"
            exit 0
          fi

          git add .

          # Create commit message with changed files
          CHANGED_FILES=$(git diff --cached --name-only | grep -E '\.md$' | head -5)
          if [[ $(echo "$CHANGED_FILES" | wc -l) -gt 5 ]]; then
            COMMIT_MSG="wiki: Auto-sync documentation updates

          Updated files:
          $(echo "$CHANGED_FILES" | head -3)
          ... and $(( $(git diff --cached --name-only | grep -E '\.md$' | wc -l) - 3 )) more files

          Source commit: ${{ github.sha }}
          Triggered by: ${{ github.event_name }}
          Sync time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          else
            COMMIT_MSG="wiki: Auto-sync documentation updates

          Updated files:
          $CHANGED_FILES

          Source commit: ${{ github.sha }}
          Triggered by: ${{ github.event_name }}
          Sync time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          fi

          git commit -m "$COMMIT_MSG"

          # Push with retry logic
          for i in {1..3}; do
            if git push origin master 2>/dev/null || git push origin main 2>/dev/null; then
              echo "âœ… Successfully pushed to Wiki"
              break
            else
              echo "âš ï¸ Push attempt $i failed, retrying..."
              sleep 2
            fi
          done

      - name: Create summary
        run: |
          cd wiki-repo

          SYNC_COUNT=$(git diff HEAD~1 --name-only | grep -E '\.md$' | wc -l)
          WIKI_URL="https://github.com/${{ github.repository }}/wiki"

          echo "## ðŸ“– Wiki Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Sync completed successfully**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Files synced**: $SYNC_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- **Wiki URL**: [$WIKI_URL]($WIKI_URL)" >> $GITHUB_STEP_SUMMARY
          echo "- **Source commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Sync time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ $SYNC_COUNT -gt 0 ]]; then
            echo "### Updated files:" >> $GITHUB_STEP_SUMMARY
            git diff HEAD~1 --name-only | grep -E '\.md$' | while read -r file; do
              echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
            done
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "## âŒ Wiki Sync Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Wiki synchronization failed. Please check the workflow logs." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Troubleshooting:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Ensure Wiki is enabled in repository settings" >> $GITHUB_STEP_SUMMARY
          echo "2. Check if there are permission issues" >> $GITHUB_STEP_SUMMARY
          echo "3. Verify the repository name and access rights" >> $GITHUB_STEP_SUMMARY
