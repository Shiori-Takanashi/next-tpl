name: Wiki Documentation Sync

on:
  push:
    branches: [main, latest]
    paths:
      - 'docs/development/**'
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync all documentation'
        required: false
        default: 'false'
        type: boolean

jobs:
  sync-documentation:
    name: Sync docs to Wiki
    runs-on: ubuntu-latest
    if: github.repository == 'Shiori-Takanashi/next-tpl'

    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git with proper authentication
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global credential.helper store
          echo "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com" > ~/.git-credentials

      - name: Check if Wiki exists and is accessible
        id: wiki-check
        run: |
          WIKI_URL="https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git"
          echo "Checking Wiki repository accessibility..."
          if git ls-remote "$WIKI_URL" &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Wiki repository exists and is accessible"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ùå Wiki repository not found or not accessible"
            echo "üîß Wiki might need to be manually initialized"
          fi

      - name: Clone or initialize Wiki
        run: |
          WIKI_URL="https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git"

          echo "üîÑ Starting Wiki sync process..."

          if [[ "${{ steps.wiki-check.outputs.exists }}" == "true" ]]; then
            echo "üì• Cloning existing Wiki repository..."
            if git clone "$WIKI_URL" wiki-repo; then
              echo "‚úÖ Wiki cloned successfully"
            else
              echo "‚ùå Failed to clone Wiki, trying to initialize..."
              mkdir -p wiki-repo
              cd wiki-repo
              git init
              git remote add origin "$WIKI_URL"
              cd ..
            fi
          else
            echo "üÜï Initializing new Wiki repository..."
            mkdir -p wiki-repo
            cd wiki-repo
            git init
            git remote add origin "$WIKI_URL"
            
            # Create initial Wiki page to establish the repository
            echo "# Welcome to the Wiki

This Wiki is automatically synchronized from the main repository.

## Auto-Sync Information
- Source: \`docs/development/\` directory  
- Last sync: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
- Auto-generated by GitHub Actions

## Navigation
- [üìã Complete Documentation Index](README)
- [üè† Back to Main Repository](https://github.com/${{ github.repository }})

*This page is automatically maintained.*" > Home.md

            git add Home.md
            git commit -m "wiki: Initialize Wiki repository"
            
            # Try to push the initial commit to create the Wiki
            echo "üöÄ Creating Wiki repository..."
            if git push -u origin master 2>/dev/null || git push -u origin main 2>/dev/null; then
              echo "‚úÖ Wiki repository created successfully"
            else
              echo "‚ö†Ô∏è Could not create Wiki repository automatically"
              echo "üí° Please manually create the Wiki by visiting:"
              echo "   https://github.com/${{ github.repository }}/wiki"
              echo "   and creating the first page, then re-run this workflow"
              exit 1
            fi
            cd ..
          fi
          echo "Repository: ${{ github.repository }}"
          echo "Wiki URL: $WIKI_URL"

          if [[ "${{ steps.wiki-check.outputs.exists }}" == "true" ]]; then
            echo "üìñ Cloning existing Wiki..."
            git clone "$WIKI_URL" wiki-repo
            cd wiki-repo
            echo "üìã Current Wiki contents:"
            ls -la *.md 2>/dev/null || echo "No markdown files found"
            cd ..
          else
            echo "üÜï Initializing new Wiki..."
            mkdir wiki-repo
            cd wiki-repo
            git init
            git remote add origin "$WIKI_URL"

            # Create initial Home page
            cat > Home.md << 'EOF'
          # Next.js Learning Template - Development Wiki

          „Åì„ÅÆWiki„Å´„ÅØ„ÄÅNext.jsÂ≠¶Áøí„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆË©≥Á¥∞„Å™ÈñãÁô∫Ë®òÈå≤„Å®ÊäÄË°ì„Éâ„Ç≠„É•„É°„É≥„Éà„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ

          ## üìã ÊúÄÊñ∞„ÅÆ„Éâ„Ç≠„É•„É°„É≥„Éà

          „Åì„ÅÆWiki„ÅØ `docs/development/` „Åã„ÇâËá™ÂãïÂêåÊúü„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ

          ### ‰∏ªË¶Å„Å™„Éâ„Ç≠„É•„É°„É≥„Éà
          - [[Project Overview|01-project-overview]] - „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆÊ¶ÇË¶Å„Å®ÁõÆÁöÑ
          - [[CI Workflow Modularization|24-ci-workflow-modularization]] - GitHub Actions CI„ÉØ„Éº„ÇØ„Éï„É≠„Éº„ÅÆ„É¢„Ç∏„É•„Éº„É´Âåñ
          - [[Development Standards|25-development-standards]] - ÈñãÁô∫Áí∞Â¢ÉÊ®ôÊ∫ñÂåñ

          ## üîó Èñ¢ÈÄ£„É™„É≥„ÇØ

          - [„É°„Ç§„É≥„É™„Éù„Ç∏„Éà„É™](https://github.com/${{ github.repository }})
          - [IssueÂ†±Âëä](https://github.com/${{ github.repository }}/issues)
          - [Pull Request](https://github.com/${{ github.repository }}/pulls)

          ---
          *ÊúÄÁµÇÊõ¥Êñ∞: {{ date }}*
          *Ëá™ÂãïÂêåÊúü: GitHub Actions*
          EOF

            git add Home.md
            git commit -m "wiki: Initialize Wiki with auto-sync"
            cd ..
          fi

      - name: Sync documentation files
        run: |
          cd wiki-repo

          echo "üìù Starting documentation sync..."
          SOURCE_FILES=$(find ../docs/development -name "*.md" | sort)
          SOURCE_COUNT=$(echo "$SOURCE_FILES" | wc -l)
          echo "üìä Source files count: $SOURCE_COUNT"
          echo "üìÅ Source files:"
          echo "$SOURCE_FILES" | sed 's|../docs/development/||g'

          # Remove existing docs (except special Wiki files)
          find . -name "*.md" -not -name "Home.md" -not -name "_*.md" -delete

          echo "üìù Syncing documentation files..."

          # Counter for successful copies
          SUCCESS_COUNT=0

          # Copy all markdown files from docs/development
          while IFS= read -r source_file; do
            if [[ -f "$source_file" ]]; then
              basename_file=$(basename "$source_file")
              echo "üìÑ Syncing: $basename_file"

              # Verify source file is readable
              if [[ -r "$source_file" ]]; then
                # Copy file with metadata
                {
                  echo "<!-- Auto-synced from docs/development/$basename_file -->"
                  echo "<!-- Last sync: $(date -u '+%Y-%m-%d %H:%M:%S UTC') -->"
                  echo "<!-- Commit: ${{ github.sha }} -->"
                  echo ""
                  cat "$source_file"
                } > "$basename_file"

                # Verify the copy was successful
                if [[ -f "$basename_file" && -s "$basename_file" ]]; then
                  SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                  echo "  ‚úÖ Successfully copied $basename_file"
                else
                  echo "  ‚ùå Failed to copy $basename_file (empty or missing)"
                fi
              else
                echo "  ‚ùå Cannot read source file: $source_file"
              fi
            else
              echo "  ‚ùå Source file not found: $source_file"
            fi
          done <<< "$SOURCE_FILES"

          echo ""
          echo "üìä Sync Results:"
          echo "  üìÅ Source files: $SOURCE_COUNT"
          echo "  ‚úÖ Successfully copied: $SUCCESS_COUNT"
          echo "  ‚ùå Failed: $((SOURCE_COUNT - SUCCESS_COUNT))"
          echo ""

          # Verify all files are in place
          WIKI_FILES=$(find . -name "*.md" -not -name "Home.md" -not -name "_*.md" | sort)
          WIKI_COUNT=$(echo "$WIKI_FILES" | grep -c .)
          echo "üìã Wiki files after sync ($WIKI_COUNT files):"
          ls -la *.md | sort

          # Final verification
          if [[ $SUCCESS_COUNT -eq $SOURCE_COUNT ]]; then
            echo "‚úÖ All files synced successfully!"
          else
            echo "‚ö†Ô∏è Some files may not have synced properly"
            exit 1
          fi

      - name: Update Wiki sidebar
        run: |
          cd wiki-repo

          cat > _Sidebar.md << 'EOF'
          ## üìö „Éâ„Ç≠„É•„É°„É≥„Éà

          ### Âü∫Áõ§„ÉªË®≠Ë®à
          * [[Project Overview|01-project-overview]]
          * [[Docker Environment|02-docker-environment]]
          * [[Automation Tools|03-automation-tools]]
          * [[Documentation Strategy|04-documentation-strategy]]

          ### „ÉÜ„Çπ„Éà„ÉªÂìÅË≥™
          * [[Testing Strategy|08-testing-strategy]]
          * [[Security Practices|09-security-practices]]
          * [[Performance Optimization|10-performance-optimization]]

          ### ÊäÄË°ìÂÆüË£Ö
          * [[TailwindCSS v4|13-tailwindcss-v4]]
          * [[VS Code Integration|14-vscode-integration]]
          * [[Next.js 16 + React 19|16-nextjs-16-react-19]]

          ### ÊúÄÊñ∞„ÅÆÊîπÂñÑ
          * [[CI Workflow Modularization|24-ci-workflow-modularization]]
          * [[Development Standards|25-development-standards]]

          ### ÈÅãÁî®„Éª„Éá„Éó„É≠„Ç§
          * [[Production Deployment|20-production-deployment]]
          * [[Tools Extension|23-tools-extension]]

          ---
          [[üìã ÂÆåÂÖ®„Å™„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ|README]]

          *Ëá™ÂãïÂêåÊúü: GitHub Actions*
          EOF

      - name: Update Wiki footer
        run: |
          cd wiki-repo

          cat > _Footer.md << 'EOF'
          ---
          üìñ [ÂÖ®„Éâ„Ç≠„É•„É°„É≥„Éà](README) | üè† [„É°„Ç§„É≥„É™„Éù„Ç∏„Éà„É™](https://github.com/${{ github.repository }}) | üêõ [IssueÂ†±Âëä](https://github.com/${{ github.repository }}/issues) | üîÑ ÊúÄÁµÇÂêåÊúü: {{ date }}
          EOF

          # Replace date placeholder
          sed -i "s/{{ date }}/$(date -u '+%Y-%m-%d %H:%M:%S UTC')/g" _Footer.md

      - name: Update Home page timestamp
        run: |
          cd wiki-repo

          if [[ -f "Home.md" ]]; then
            sed -i "s/\*ÊúÄÁµÇÊõ¥Êñ∞:.*\*/\*ÊúÄÁµÇÊõ¥Êñ∞: $(date -u '+%Y-%m-%d %H:%M:%S UTC')\*/" Home.md
          fi

      - name: Commit and push changes
        run: |
          cd wiki-repo

          # Stage all changes
          git add .

          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "‚ÑπÔ∏è No changes to commit"
            exit 0
          fi

          echo "üìù Preparing commit with change summary..."

          # Count changed files
          CHANGED_MD_FILES=$(git diff --cached --name-only | grep -E '\.md$' || true)
          CHANGED_COUNT=$(echo "$CHANGED_MD_FILES" | grep -v '^$' | wc -l)

          echo "üìä Changed files: $CHANGED_COUNT"
          echo "$CHANGED_MD_FILES"

          # Create comprehensive commit message
          if [[ $CHANGED_COUNT -gt 0 ]]; then
            COMMIT_MSG="wiki: Auto-sync documentation updates (${CHANGED_COUNT} files)

          üìä Sync Summary:
          - Total files synced: ${CHANGED_COUNT}
          - Source: docs/development/
          - Target: GitHub Wiki

          üìù Updated files:
          $(echo "$CHANGED_MD_FILES" | head -10 | sed 's/^/  - /')
          $(if [[ $CHANGED_COUNT -gt 10 ]]; then echo "  ... and $((CHANGED_COUNT - 10)) more files"; fi)

          üîó Source commit: ${{ github.sha }}
          üöÄ Triggered by: ${{ github.event_name }}
          ‚è∞ Sync time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          else
            COMMIT_MSG="wiki: Auto-sync metadata updates

          üîÑ Updated Wiki structure and metadata
          üîó Source commit: ${{ github.sha }}
          ‚è∞ Sync time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          fi

          git commit -m "$COMMIT_MSG"

          # Push with improved retry logic and proper authentication
          echo "üöÄ Pushing to Wiki repository..."
          PUSH_SUCCESS=false
          
          # Set up authenticated remote URL
          WIKI_AUTH_URL="https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git"
          git remote set-url origin "$WIKI_AUTH_URL"

          for i in {1..3}; do
            echo "üì§ Push attempt $i/3..."

            # Get current branch name
            CURRENT_BRANCH=$(git branch --show-current)
            echo "üîç Current branch: $CURRENT_BRANCH"

            # Try to push to current branch, then try master, then main
            if git push origin "$CURRENT_BRANCH" 2>/dev/null; then
              echo "‚úÖ Successfully pushed to $CURRENT_BRANCH branch"
              PUSH_SUCCESS=true
              break
            elif git push origin master 2>/dev/null; then
              echo "‚úÖ Successfully pushed to master branch"
              PUSH_SUCCESS=true
              break
            elif git push origin main 2>/dev/null; then
              echo "‚úÖ Successfully pushed to main branch"
              PUSH_SUCCESS=true
              break
            else
              echo "‚ö†Ô∏è Push attempt $i failed"
              if [[ $i -lt 3 ]]; then
                echo "üîÑ Retrying in $((i * 2)) seconds..."
                sleep $((i * 2))
                
                # Try to fetch and rebase before retry
                echo "üîÑ Fetching latest changes..."
                git fetch origin 2>/dev/null || true
                
                # Try to rebase if possible
                if git rebase origin/master 2>/dev/null; then
                  echo "‚úÖ Rebased on master successfully"
                elif git rebase origin/main 2>/dev/null; then
                  echo "‚úÖ Rebased on main successfully"
                else
                  echo "‚ö†Ô∏è Rebase not needed or failed, continuing..."
                fi
              fi
            fi
          done

          if [[ "$PUSH_SUCCESS" != "true" ]]; then
            echo "‚ùå Failed to push after 3 attempts"
            echo ""
            echo "üîß Troubleshooting steps:"
            echo "1. Ensure the Wiki is enabled in repository settings"
            echo "2. Try manually creating a Wiki page at:"
            echo "   https://github.com/${{ github.repository }}/wiki"
            echo "3. Check repository permissions"
            echo ""
            echo "üí° If Wiki doesn't exist, create it manually:"
            echo "   - Go to https://github.com/${{ github.repository }}/wiki"
            echo "   - Click 'Create the first page'"
            echo "   - Add any content and save"
            echo "   - Then re-run this workflow"
            exit 1
          fi

          echo "üéâ Wiki sync completed successfully!"

      - name: Create detailed summary
        run: |
          cd wiki-repo

          # Collect comprehensive sync statistics
          TOTAL_MD_FILES=$(find . -name "*.md" | wc -l)
          DOC_FILES=$(find . -name "*.md" -not -name "Home.md" -not -name "_*.md" | wc -l)
          WIKI_URL="https://github.com/${{ github.repository }}/wiki"
          LATEST_COMMIT=$(git log -1 --format="%h %s")

          echo "ÔøΩ === Detailed Wiki Sync Summary ==="
          echo "üéØ Repository: ${{ github.repository }}"
          echo "üîó Wiki URL: $WIKI_URL"
          echo "üìä Statistics:"
          echo "  - Total Wiki files: $TOTAL_MD_FILES"
          echo "  - Documentation files: $DOC_FILES"
          echo "  - Source directory: docs/development/"
          echo "  - Last commit: $LATEST_COMMIT"
          echo "  - Sync time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "  - Source commit: ${{ github.sha }}"
          echo ""
          echo "üìÅ All Wiki files:"
          find . -name "*.md" | sort | sed 's|^./||' | sed 's/^/  üìÑ /'
          echo ""
          echo "üöÄ Wiki is now fully synchronized!"
          echo "üëÄ View at: $WIKI_URL"

          # Create comprehensive GitHub Step Summary
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## üìö Wiki Synchronization Complete

          ### üìä Sync Results
          - ‚úÖ **Repository**: \`${{ github.repository }}\`
          - üìÅ **Documentation files synced**: **${DOC_FILES}** files
          - üìã **Total Wiki files**: ${TOTAL_MD_FILES} files
          - üîó **Source commit**: [\`${{ github.sha }}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          - ‚è∞ **Sync time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          ### üéØ Access Your Wiki
          - [üìñ **View Wiki**](${WIKI_URL})
          - [üè† **Wiki Home**](${WIKI_URL}/Home)
          - [üìã **Complete Index**](${WIKI_URL}/README)

          ### üìù Synchronized Files
          $(find . -name "*.md" -not -name "Home.md" -not -name "_*.md" | sort | sed 's|^./||' | sed 's/^/- `/' | sed 's/$/`/')

          ### üîÑ Automation Details
          - **Source**: \`docs/development/\` directory
          - **Target**: GitHub Wiki repository
          - **Method**: Automated sync via GitHub Actions
          - **Trigger**: Push to \`docs/development/**\` files

          > ü§ñ **Fully automated** - Your local markdown files are now live on GitHub Wiki!
          EOF

      - name: Notify on failure
        if: failure()
        run: |
          echo "## ‚ùå Wiki Sync Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The Wiki synchronization failed. This is likely due to one of the following reasons:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîß Common Issues and Solutions:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Wiki not initialized**" >> $GITHUB_STEP_SUMMARY
          echo "   - Go to [Wiki page](https://github.com/${{ github.repository }}/wiki)" >> $GITHUB_STEP_SUMMARY
          echo "   - Click 'Create the first page'" >> $GITHUB_STEP_SUMMARY
          echo "   - Add any content and save" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "2. **Repository permissions**" >> $GITHUB_STEP_SUMMARY
          echo "   - Ensure Wiki is enabled in repository settings" >> $GITHUB_STEP_SUMMARY
          echo "   - Check Actions permissions in repository settings" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "3. **Authentication issues**" >> $GITHUB_STEP_SUMMARY
          echo "   - GITHUB_TOKEN should have wiki write permissions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üöÄ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Manually create the Wiki if it doesn't exist" >> $GITHUB_STEP_SUMMARY
          echo "2. Re-run this workflow using the 'Re-run jobs' button" >> $GITHUB_STEP_SUMMARY
          echo "3. Or trigger it by making a change to any file in \`docs/development/\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Verify the repository name and access rights" >> $GITHUB_STEP_SUMMARY
