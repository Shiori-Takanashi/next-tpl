name: Deploy to Production

on:
  push:
  workflow_dispatch:

jobs:
  # æœ¬ç•ªç’°å¢ƒãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
  build-production:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: |
          npm run type-check
          npm run lint
          npm run format:check

      - name: Build for production
        env:
          NODE_ENV: production
        run: npm run build

      - name: Test production build
        run: |
          npm start &
          sleep 10
          npm run health
          pkill -f "npm start"

  # Dockeræœ¬ç•ªãƒ“ãƒ«ãƒ‰
  build-docker:
    needs: build-production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Show files (debug)
        run: ls -la

      - name: Build production Docker image
        run: |
          docker build -t next-tpl:latest .
          docker run --name test-container -d -p 3000:3000 next-tpl:latest
          sleep 30
          curl -f http://localhost:3000/api/health
          docker stop test-container
          docker rm test-container

      - name: Save Docker image
        run: |
          docker save next-tpl:latest | gzip > next-tpl-latest.tar.gz

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v3
        with:
          name: docker-image
          path: next-tpl-latest.tar.gz
          retention-days: 1

  # æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆæ‰‹å‹•æ‰¿èªå¿…è¦ï¼‰
  deploy-production:
    needs: [build-production, build-docker]
    runs-on: ubuntu-latest
    environment: production
    if: github.ref == 'workflow_dispatch' || 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Docker image
        uses: actions/download-artifact@v3
        with:
          name: docker-image

      - name: Load Docker image
        run: |
          docker load < next-tpl-latest.tar.gz

      - name: Deploy to production
        run: |
          echo "ğŸš€ æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹"
          # ã“ã“ã«å®Ÿéš›ã®ãƒ‡ãƒ—ãƒ­ã‚¤å‡¦ç†ã‚’è¿½åŠ 
          # ä¾‹: docker-compose -f docker-compose.prod.yml up -d
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"

      - name: Health check
        run: |
          echo "ğŸ” ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
          # æœ¬ç•ªç’°å¢ƒã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
          # curl -f ${{ secrets.PRODUCTION_URL }}/api/health
