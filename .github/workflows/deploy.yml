name: Deploy to Production

on:
  push: # ã™ã¹ã¦ã®ãƒ–ãƒ©ãƒ³ãƒã‚’å¯¾è±¡ã«ã™ã‚‹
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.11.0"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run basic checks
        run: |
          npm run type-check
          npm run lint
          npm run format:check

  build:
    needs: check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.11.0"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Test build output
        run: |
          ls -la .next/
          echo "âœ… Build completed successfully"

  docker-build:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t next-tpl:test .
          echo "âœ… Docker image built successfully"

      - name: Test Docker image
        run: |
          docker run --name test-container -d -p 3000:3000 next-tpl:test
          sleep 15
          docker ps
          docker stop test-container
          docker rm test-container
          echo "âœ… Docker container test passed"

  deploy-ready:
    needs: [check, build, docker-build]
    runs-on: ubuntu-latest
    steps:
      - name: Deploy readiness notification
        run: |
          echo "ğŸš€ All checks passed - Ready for production deployment"
          echo "âœ… Type check: passed"
          echo "âœ… Linting: passed"
          echo "âœ… Build: passed"
          echo "âœ… Docker: passed"
