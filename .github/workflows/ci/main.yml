name: CI Pipeline

on:
  push:
    branches: [main, latest, develop]
  pull_request:
    branches: [main, latest]

jobs:
  setup:
    uses: ./.github/workflows/ci-setup.yml

  lint:
    needs: setup
    uses: ./.github/workflows/ci-lint.yml
    with:
      cache-key: ${{ needs.setup.outputs.cache-key }}

  type-check:
    needs: setup
    uses: ./.github/workflows/ci-type-check.yml
    with:
      cache-key: ${{ needs.setup.outputs.cache-key }}

  build:
    needs: setup
    uses: ./.github/workflows/ci-build.yml
    with:
      cache-key: ${{ needs.setup.outputs.cache-key }}

  security:
    needs: setup
    uses: ./.github/workflows/ci-security.yml
    with:
      cache-key: ${{ needs.setup.outputs.cache-key }}

  final-check:
    needs: [lint, type-check, build, security]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.lint.result }}" == "success" &&
                "${{ needs.type-check.result }}" == "success" &&
                "${{ needs.build.result }}" == "success" &&
                "${{ needs.security.result }}" == "success" ]]; then
            echo "✅ All CI checks passed!"
            exit 0
          else
            echo "❌ Some CI checks failed"
            exit 1
          fi
