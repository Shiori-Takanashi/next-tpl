name: CI Check

on:
  push:
    branches: [main, latest]
  pull_request:
    branches: [main, latest]
  workflow_dispatch:

jobs:
  setup:
    uses: ./.github/workflows/ci-setup.yml

  lint:
    needs: setup
    uses: ./.github/workflows/ci-lint.yml
    with:
      cache-key: ${{ needs.setup.outputs.cache-key }}

  type-check:
    needs: setup
    uses: ./.github/workflows/ci-type-check.yml
    with:
      cache-key: ${{ needs.setup.outputs.cache-key }}

  build:
    needs: [lint, type-check]
    uses: ./.github/workflows/ci-build.yml
    with:
      cache-key: ${{ needs.setup.outputs.cache-key }}

  security:
    needs: build
    uses: ./.github/workflows/ci-security.yml
    with:
      cache-key: ${{ needs.setup.outputs.cache-key }}

  summary:
    name: Summarize CI results
    needs: [lint, type-check, build, security]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Show job results
        run: |
          echo "Lint: ${{ needs.lint.result }}"
          echo "Type-check: ${{ needs.type-check.result }}"
          echo "Build: ${{ needs.build.result }}"
          echo "Security: ${{ needs.security.result }}"
          if [[ "${{ needs.lint.result }}" != "success" || \
                "${{ needs.type-check.result }}" != "success" || \
                "${{ needs.build.result }}" != "success" || \
                "${{ needs.security.result }}" != "success" ]]; then
            echo "❌ Some checks failed."
            exit 1
          else
            echo "✅ All checks passed."
          fi
